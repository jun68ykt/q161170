<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Q161170</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        function getTextNodes(root) {
            const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            let node;
            while(node = walker.nextNode()) {
                if (node.nodeValue.trim().length > 0) {
                    textNodes.push(node);
                }
            }
            return textNodes;
        }

        function getReplacementsForTextNode(textNode, replacer) {
            // parent が <a> の場合、置き換えを行わない
            if (textNode.parentNode.tagName === 'A') {
                return { rpls: null };
            }

            const rpls = [];
            let m;
            let str = textNode.nodeValue;
            let includingTags = false;

            while ( m = /#([^\s#]+)/.exec(str)) {
                if (!includingTags) includingTags = true;

                if (m.index > 0) {
                    const subTextNode = document.createTextNode(str.substring(0, m.index));
                    rpls.push(subTextNode);
                }

                rpls.push(replacer(m[0]));

                str = str.substring(m.index + m[0].length);
            }
            if (str.length > 0) {
                rpls.push(document.createTextNode(str));
            }
            return { rpls, includingTags };
        }

        function replaceTextNode(textNode, rpls) {
            if (!rpls || !rpls.length) return;

            const parent = textNode.parentNode;
            parent.replaceChild(rpls[rpls.length-1], textNode);

            if (rpls.length > 1) {
                for (let i = rpls.length-2; i >= 0; i -= 1 ) {
                    parent.insertBefore(rpls[i], rpls[i+1]);
                }
            }
        }

        function createLinkForTag(tag) {
            const a = document.createElement("a");
            a.setAttribute('href', `https://dummyimage.com/600x400/000000/fff&text=${tag.substring(1)}`);
            a.setAttribute('target', '_blank');
            a.appendChild(document.createTextNode(tag));
            return a;
        }

        $(function(){
            $('button').on('click', function() {
                const textNodes = getTextNodes(document.getElementById('outer'));

                textNodes.forEach(t => {
                    const { rpls, includingTags } = getReplacementsForTextNode(t, createLinkForTag);
                    if (rpls && includingTags) {
                        replaceTextNode(t, rpls);
                    }
                });
            })
        });
    </script>
</head>
<body>
    <div id="outer" style="background-color: #ddd; padding: 20px;">
    #tag1 #tag2 tag3 #tag4<br />
        <div>
            <p>
                <a href="https://teratail.com/questions/161170">Teratail Question #161170</a>
            </p>
            <br />tag5 #tag6 #tag7 tag8
        </div>
    </div>

    <div style="margin: 10px; text-align: center;">
        <button>タグをリンクにする。</button>
    </div>
</body>
</html>
